name: Build Self-Hosting Docker Images
on:
  push:
    branches:
      - main
      - self-host-updates
      - multi-arch-builds
    paths-ignore:
      - 'apple/**'
      - 'android/**'

jobs:
  build-self-hostdocker-images:
    name: Build self-host docker images
    permissions:
      contents: read
      packages: write
      attestations: write
      id-token: write
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: 'Login to GitHub container registry'
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{github.actor}}
          password: ${{secrets.GITHUB_TOKEN}}
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push backend
        uses: docker/build-push-action@v6
        with:
          platforms: linux/amd64,linux/arm64
          push: true
          tags: sh-backend:latest,sh-backend:${GITHUB_SHA}
          file: packages/api/Dockerfile
      - name: Build and push content-fetch
        uses: docker/build-push-action@v6
        with:
          platforms: linux/amd64,linux/arm64
          push: true
          tags: sh-content-fetch:latest,sh-content-fetch:${GITHUB_SHA}
          file: packages/content-fetch/Dockerfile
      - name: Build and push queue-processor
        uses: docker/build-push-action@v6
        with:
          platforms: linux/amd64,linux/arm64
          push: true
          tags: sh-queue-processor:latest,sh-queue-processor:${GITHUB_SHA}
          file: packages/api/queue-processor/Dockerfile
      - name: Build and push migrate
        uses: docker/build-push-action@v6
        with:
          platforms: linux/amd64,linux/arm64
          push: true
          tags: sh-migrate:latest,sh-migrate:${GITHUB_SHA}
          file: packages/db/Dockerfile
      - name: Build and push image-proxy
        uses: docker/build-push-action@v6
        with:
          platforms: linux/amd64,linux/arm64
          push: true
          tags: sh-image-proxy:latest,sh-image-proxy:${GITHUB_SHA}
          file: imageproxy/Dockerfile
      - name: Build and push local-mail-watcher
        uses: docker/build-push-action@v6
        with:
          platforms: linux/amd64,linux/arm64
          push: true
          tags: sh-local-mail-watcher:latest,sh-local-mail-watcher:${GITHUB_SHA}
          file: packages/local-mail-watcher/Dockerfile
